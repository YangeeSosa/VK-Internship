# PubSub gRPC Server

Простой сервер pub/sub, реализованный с использованием gRPC.

## Запуск с помощью Docker Compose


## Запуск сервера:
```bash
docker-compose up -d
```

Сервер будет доступен на порту 50051.

## Остановка сервера

```bash
docker-compose down
```

Сервис реализует систему публикации-подписки (pub/sub) с использованием gRPC. Проект состоит из двух основных частей:
1. Базовый пакет `subpub` для работы с событиями
2. gRPC сервис, предоставляющий API для работы с системой pub/sub

## Архитектура

### Пакет subpub

Пакет реализует базовую функциональность pub/sub системы:
- Поддержка множества подписчиков на один subject
- Асинхронная доставка сообщений через буферизированные каналы
- Thread-safe реализация с использованием мьютексов
- FIFO очередь для сообщений
- Graceful shutdown с поддержкой контекста
- Защита от блокировки медленными подписчиками

### gRPC Сервис

Сервис предоставляет два основных метода:
- `Subscribe(SubscribeRequest) returns (stream Event)` - подписка на события по ключу
- `Publish(PublishRequest) returns (Empty)` - публикация события для всех подписчиков

## Зависимости

- Go 1.21 или выше
- Protocol Buffers compiler (protoc)
- gRPC зависимости:
  - google.golang.org/grpc
  - google.golang.org/protobuf

## Сборка и запуск

1. Установка зависимостей:
```bash
go mod download
```

2. Генерация gRPC кода (если нужно изменить API):
```bash
protoc --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    api/pubsub.proto
```

3. Конфигурация:
Настройка конфигурации в `config.json`:
```json
{
    "grpc_port": ":50051"
}
```

4. Запуск сервера:
```bash
go run cmd/server/main.go
```

## Обработка ошибок

Сервис использует стандартные коды ошибок gRPC:
- `InvalidArgument` - пустой ключ
- `Internal` - внутренние ошибки сервера
- `Canceled` - контекст отменен или сервис остановлен

## Мониторинг и логирование

- Сервис логирует основные события: запуск, остановку, ошибки
- Все ошибки записываются в лог с соответствующим уровнем
- При graceful shutdown корректно закрываются все соединения

## Безопасность

- Все операции thread-safe
- Защита от утечек памяти через корректное закрытие каналов
- Защита от блокировки медленными подписчиками

## Тестирование

Проект включает unit-тесты для пакета subpub:
```bash
go test ./pkg/subpub -v
```

## Производительность

- Асинхронная обработка сообщений
- Буферизированные каналы для оптимизации производительности